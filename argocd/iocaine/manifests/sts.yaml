apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: iocaine
  labels:
    app: iocaine
spec:
  serviceName: "iocaine"
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: iocaine
  template:
    metadata:
      labels:
        app: iocaine
    spec:
      initContainers:
        - name: pull-data
          image: harbor.yanello.net/docker/curlimages/curl:8.18.0@sha256:d94d07ba9e7d6de898b6d96c1a072f6f8266c687af78a74f380087a0addf5d17
          securityContext:
            runAsUser: 0
          command:
            - "/bin/sh"
            - "-c"
            - |
              cd /opt/iocaine/share/data
              echo "Checking for existing data files..."
  
              if [ ! -f "1984.txt" ]; then
                echo "Downloading 1984.txt..."
                curl -s -L https://archive.org/download/GeorgeOrwells1984/1984_djvu.txt -o 1984.txt
              else
                echo "1984.txt already exists, skipping download."
              fi
  
              if [ ! -f "brave-new-world.txt" ]; then
                echo "Downloading brave-new-world.txt..."
                curl -s -L https://archive.org/download/ost-english-brave_new_world_aldous_huxley/Brave_New_World_Aldous_Huxley_djvu.txt -o brave-new-world.txt
              else
                echo "brave-new-world.txt already exists, skipping download."
              fi
  
              if [ ! -f "words.txt" ]; then
                echo "Downloading words.txt..."
                curl -s -L https://git.savannah.gnu.org/cgit/miscfiles.git/plain/web2 -o words.txt
              else
                echo "words.txt already exists, skipping download."
              fi
  
              if [ ! -f "ai.robots.txt-robots.json" ]; then
                echo "Downloading ai.robots.txt-robots.json..."
                curl -s -L https://github.com/ai-robots-txt/ai.robots.txt/raw/refs/heads/main/robots.json -o ai.robots.txt-robots.json
              else
                echo "ai.robots.txt-robots.json already exists, skipping download."
              fi
  
              echo "Data initialization complete."
          volumeMounts:
            - name: iocaine-persistent
              mountPath: /opt/iocaine/share/data/
      containers:
        - name: iocaine
          image: harbor.yanello.net/madhouse/iocaine/iocaine:3.1.0@sha256:12a07c69363356f045171e432fe6d54eb6b94bc33996eaa52f70d6ab1e46f374
          command: ["iocaine"]
          args: ["-c", "/etc/iocaine/config.d"]
          ports:
            - containerPort: 8080
              protocol: TCP
            - containerPort: 8181
              protocol: TCP
          imagePullPolicy: Always
          resources:
            requests:
              memory: 50Mi
              cpu: 100m
            limits:
              memory: 200Mi
          volumeMounts:
            - name: config
              mountPath: /etc/iocaine/config.d/config.kdl
              subPath: config.kdl
            - name: metrics
              mountPath: /etc/iocaine/config.d/metrics.kdl
              subPath: metrics.kdl
            - name: iocaine-persistent
              mountPath: /opt/iocaine/share/data/
      volumes:
        - name: config
          configMap:
            name: config
        - name: metrics
          configMap:
            name: metrics
  volumeClaimTemplates:
    - metadata:
        name: iocaine-persistent
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "truenas-hdd-nfs"
        resources:
          requests:
            storage: 1Gi
