apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: iocaine
  labels:
    app: iocaine
spec:
  serviceName: "iocaine"
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: iocaine
  template:
    metadata:
      labels:
        app: iocaine
    spec:
      containers:
        - name: iocaine
          image: git.madhouse-project.org/iocaine/iocaine:2
          command: ["iocaine"]
          args: ["--config-file", "/etc/iocaine/config.toml"]
          ports:
            - containerPort: 8080
              protocol: TCP
          imagePullPolicy: Always
          resources:
            requests:
              memory: 50Mi
              cpu: 100m
            limits:
              memory: 200Mi
              cpu: "1"
          volumeMounts:
            - name: config
              mountPath: /etc/iocaine/config.toml
              subPath: config.toml
            - name: "data"
              mountPath: /opt/iocaine/share/data/1984.txt
              subPath: "1984.txt"
            - name: "data"
              mountPath: /opt/iocaine/share/data/brave-new-world.txt
              subPath: "brave-new-world.txt"
            - name: "data"
              mountPath: "/opt/iocaine/share/data/words.txt"
              subPath: "words.txt"
      volumes:
        - name: config
          configMap:
            name: config
        - name: data
          configMap:
            name: data
  volumeClaimTemplates:
    - metadata:
        name: iocaine-persistent
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "longhorn-xfs"
        resources:
          requests:
            storage: 1Gi
