apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: iocaine
  labels:
    app: iocaine
spec:
  serviceName: "iocaine"
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: iocaine
  template:
    metadata:
      labels:
        app: iocaine
    spec:
      initContainers:
        - name: pull-data
          image: docker.io/curlimages/curl:8.16.0@sha256:463eaf6072688fe96ac64fa623fe73e1dbe25d8ad6c34404a669ad3ce1f104b6
          securityContext:
            runAsUser: 0
          command:
            - "/bin/sh"
            - "-c"
            - |
              cd /opt/iocaine/share/data
              echo "Pulling data..."
              curl -s -L https://archive.org/download/GeorgeOrwells1984/1984_djvu.txt -o 1984.txt
              curl -s -L https://archive.org/download/ost-english-brave_new_world_aldous_huxley/Brave_New_World_Aldous_Huxley_djvu.txt -o brave-new-world.txt
              curl -s -L https://git.savannah.gnu.org/cgit/miscfiles.git/plain/web2 -o words.txt
              curl -s -L https://github.com/ai-robots-txt/ai.robots.txt/raw/refs/heads/main/robots.json -o ai.robots.txt-robots.json
              echo "Successfully pulled data."
          volumeMounts:
            - name: iocaine-persistent
              mountPath: /opt/iocaine/share/data/
      containers:
        - name: iocaine
          image: git.madhouse-project.org/iocaine/iocaine:2.5.1@sha256:9ba6f3ba5520964f6905ceb10cb1d358144ebfa84f7f101a33e25fbcddb8f867
          command: ["iocaine"]
          args: ["--config-file", "/etc/iocaine/config.toml"]
          ports:
            - containerPort: 8080
              protocol: TCP
            - containerPort: 8181
              protocol: TCP
          imagePullPolicy: Always
          resources:
            requests:
              memory: 50Mi
              cpu: 100m
            limits:
              memory: 200Mi
              cpu: "1"
          volumeMounts:
            - name: config
              mountPath: /etc/iocaine/config.toml
              subPath: config.toml
            - name: iocaine-persistent
              mountPath: /opt/iocaine/share/data/
      volumes:
        - name: config
          configMap:
            name: config
  volumeClaimTemplates:
    - metadata:
        name: iocaine-persistent
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: "longhorn-xfs"
        resources:
          requests:
            storage: 1Gi
