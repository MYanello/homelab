apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

generators:
  - ./secret-generator.yaml

helmCharts:
  - name: velero
    releaseName: velero
    namespace: velero
    repo: https://vmware-tanzu.github.io/helm-charts
    version: 11.0.0
    valuesInline:
      initContainers:
        - name: velero-plugin-for-aws
          image: velero/velero-plugin-for-aws:v1.13.0@sha256:0b08ec0d150424fa914487e6665d7c84fff0c6a8eca76a23fa6d09e621d36d8a
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - mountPath: /target
              name: plugins
      credentials:
        useSecret: true
        existingSecret: cloud-credentials
      configuration:
        backupStorageLocation:
          - name: backblaze
            provider: aws
            bucket: myanello-velero
            default: true
            credential:
              name: cloud-credentials
              key: cloud
            config:
              region: us-west-004
              s3Url: https://s3.us-west-004.backblazeb2.com
        volumeSnapshotLocation:
          - name: backblaze
            provider: aws
            bucket: myanello-velero
            default: true
            credential:
              name: cloud-credentials
              key: cloud
            config:
              region: us-west-004
              s3Url: https://s3.us-west-004.backblazeb2.com
      deployNodeAgent: true
      nodeAgent:
        podVolumePath: /var/lib/kubelet/pods
        privileged: false
        tolerations:
          - effect: NoSchedule
            operator: Exists
          - effect: NoExecute
            operator: Exists
        schedules:
          weekly:
            disabled: false
            schedule: "0 0 * * 1" # mondays
            paused: false
            skipImmediately: false
            template:
              ttl: "672h" # 1 month 
              storageLocation: default
