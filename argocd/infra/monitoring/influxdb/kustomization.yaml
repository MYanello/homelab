apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

generators:
  - secret-generator.yaml

helmCharts:
  - name: influxdb
    repo: https://helm.influxdata.com/
    version: "4.12.5"
    releaseName: influxdb
    namespace: monitoring
    valuesInline: 
      image:
        tag: 1.12.2-alpine
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      service: 
        type: LoadBalancer
        loadBalancerIP: 10.10.8.0
      persistence:
        storageClassName: truenas-hdd
      setDefaultUser:
        enabled: true
        user:
          existingSecret: influx-secrets
      initScripts:
        enabled: true
        scripts: 
          init.iql: |+
            CREATE DATABASE "home"
            CREATE RETENTION POLICY "2_years" ON "home" DURATION 730d REPLICATION 1 DEFAULT
            CREATE DATABASE "GarminStats"
            DROP RETENTION POLICY "autogen" ON "GarminStats"
            CREATE RETENTION POLICY "2_years" ON "GarminStats" DURATION 730d REPLICATION 1 DEFAULT
      backup:
        enabled: false
        s3:
          credentialsSecret: ""
          destination: "s3://bucket/path"
          endpointUrl: "Specify if you're using an alternate S3 endpoint."

patches:
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: StatefulSet