apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: pod-log
spec:
  mode: daemonset
  env:
    - name: KUBE_NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
  volumes:
    - name: varlogpods
      hostPath:
        path: /var/log/pods
  volumeMounts:
    - name: varlogpods
      mountPath: /var/log/pods
      readOnly: true
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
  hostNetwork: false
  config:
    processors:
      batch:
        send_batch_size: 1000
        timeout: 10s
      deltatocumulative:
        max_stale: 5m
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        filter:
          node_from_env_var: KUBE_NODE_NAME
        extract:
          metadata:
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.deployment.name
            - k8s.namespace.name
            - k8s.node.name
            - k8s.pod.start_time
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: connection
      # Resource processor to ensure attributes are properly set
      resource:
        attributes:
          - key: k8s.cluster.name
            value: "homelab"
            action: upsert
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: "0.0.0.0:4317"
          http:
            endpoint: "0.0.0.0:4318"
      filelog:
        include: ["/var/log/pods/**/*.log"]
        start_at: beginning
    exporters:
      otlphttp/victoriametrics:
        encoding: proto
        compression: gzip
        metrics_endpoint: http://vmsingle-victoria-metrics-k8s-stack.monitoring.svc.cluster.local:8429/opentelemetry/v1/metrics
        logs_endpoint: http://victoria-logs-single-server.monitoring.svc.cluster.local:9428/insert/opentelemetry/v1/logs
      debug:
        verbosity: detailed
    service:
      pipelines:
        logs:
          receivers: [otlp, filelog]
          processors: [batch]
          exporters: [otlphttp/victoriametrics]
        metrics:
          receivers: [otlp]
          processors: [deltatocumulative]
          exporters: [otlphttp/victoriametrics]
