apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: gateway-api
spec:
  addresses:
    - value: 10.10.8.1 # the ip of the load balancer service
      type: IPAddress
  gatewayClassName: istio
  listeners:
    - name: http
      protocol: HTTP
      hostname: "*.yanello.net"
      port: 80
      allowedRoutes:
        namespaces:
          from: All
        kinds:
          - kind: HTTPRoute
    - name: http-root # need a separate listener for the root domain
      protocol: HTTP
      hostname: "yanello.net"
      port: 80
      allowedRoutes:
        namespaces:
          from: All
        kinds:
          - kind: HTTPRoute
    - name: https
      protocol: HTTPS
      hostname: "*.yanello.net"
      port: 443
      tls:
        mode: Terminate # terminate at the edge gateway for now. mtls from gateway to services should be possible
        certificateRefs:
          - name: default-ingress-cert
      allowedRoutes:
        namespaces:
          from: All
        kinds:
          - kind: HTTPRoute
    - name: https-root # need a separate listener for the root domain
      protocol: HTTPS
      hostname: "yanello.net"
      port: 443
      tls:
        mode: Terminate
        certificateRefs:
          - name: default-ingress-cert
      allowedRoutes:
        namespaces:
          from: All
        kinds:
          - kind: HTTPRoute
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: http-redirect # send http traffic to the https listener
spec:
  parentRefs:
    - name: gateway-api # what gateway is this route for
      sectionName: http
  hostnames:
    - "*.yanello.net"
    - "yanello.net"
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
# apiVersion: gateway.networking.k8s.io/v1
# kind: Gateway
# metadata:
#   name: tls-passthrough-gateway
# spec:
#   addresses:
#     - value: 10.10.8.1
#       type: IPAddress
#   gatewayClassName: istio
#   listeners:
#     - name: gateway-tls-passthrough
#       protocol: TLS
#       port: 443
#       hostname: "*.yanello.net"
#       tls:
#         mode: Passthrough
#       allowedRoutes:
#         namespaces:
#           from: All
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler # we want to have extra gateways so I can reboot my servers
metadata:
  name: gateway
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: gateway-api-istio
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/instance: istio-resources
    gateway.istio.io/managed: istio.io-gateway-controller
    gateway.networking.k8s.io/gateway-name: gateway-api
  name: gateway-api-istio
  namespace: istio-system
  ownerReferences:
  - apiVersion: gateway.networking.k8s.io/v1beta1
    kind: Gateway
    name: gateway-api
spec:
  allocateLoadBalancerNodePorts: true
  clusterIP: 10.43.225.53
  clusterIPs:
  - 10.43.225.53
  externalTrafficPolicy: Local
  healthCheckNodePort: 32509
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: PreferDualStack
  loadBalancerIP: 10.10.8.1
  ports:
  - appProtocol: tcp
    name: status-port
    nodePort: 32418
    port: 15021
    protocol: TCP
    targetPort: 15021
  - appProtocol: http
    name: http
    nodePort: 31843
    port: 80
    protocol: TCP
    targetPort: 80
  - appProtocol: https
    name: https
    nodePort: 31137
    port: 443
    protocol: TCP
    targetPort: 443
  selector:
    gateway.networking.k8s.io/gateway-name: gateway-api
  type: LoadBalancer
